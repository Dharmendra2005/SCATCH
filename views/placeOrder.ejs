<%- include('./partials/header') %>

<div class="py-16 flex shadow px-20 gap-6">

    <!-- LEFT: ADDRESS FORM -->
    <div class="w-[60%]">
        <div class="rounded-xl p-6 mb-6 mt-6">
            <h4 class="text-2xl mb-5">Create your Address</h4>

            <form autocomplete="off" action="/address/collectAddress"
                method="post">

                <!-- CONTACT DETAILS -->
                <h2 class="mb-2">Contact Details</h2>

                <div class="relative mb-4">
                    <input
                        type="text"
                        name="name"
                        required
                        placeholder=" "
                        class="peer w-3/4 px-3 py-2 bg-secondary border border-custom rounded-lg focus:border-blue-500" />
                    <label
                        class="absolute left-3 top-0 text-gray-400  px-1 text-opacity-40
          peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-base
          peer-focus:-top-2 peer-focus:text-sm peer-focus:text-yellow-500">
                        Name*
                    </label>
                </div>

                <div class="relative mb-4">
                    <input
                        type="tel"
                        name="number"
                        required
                        maxlength="10"
                        placeholder=" "
                        class="peer w-3/4 px-3 py-2 bg-secondary border border-custom rounded-lg focus:border-blue-500" />
                    <label
                        class="absolute left-3 top-2 text-gray-400  px-1 text-opacity-40
          peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-base
          peer-focus:-top-2 peer-focus:text-sm peer-focus:text-yellow-500">
                        Mobile Number*
                    </label>
                </div>

                <!-- ADDRESS -->
                <h2 class="mb-2">Address</h2>

                <div class="relative mb-4">
                    <input
                        type="text"
                        name="pincode"
                        required
                        maxlength="6"
                        placeholder=" "
                        class="peer w-3/4 px-3 py-2 bg-secondary border border-custom rounded-lg focus:border-blue-500" />
                    <label
                        class="absolute left-3 top-2 text-gray-400  px-1 text-opacity-40
          peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-base
          peer-focus:-top-2 peer-focus:text-sm peer-focus:text-yellow-500">
                        Pin Code*
                    </label>
                </div>

                <div class="relative mb-4">
                    <input
                        type="text"
                        name="house"
                        required
                        placeholder=" "
                        class="peer w-3/4 px-3 py-2 bg-secondary border border-custom rounded-lg focus:border-blue-500" />
                    <label
                        class="absolute left-3 top-2 text-gray-400  px-1 text-opacity-40
          peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-base
          peer-focus:-top-2 peer-focus:text-sm peer-focus:text-yellow-500">
                        House Number / Tower / Block*
                    </label>
                </div>

                <div class="relative mb-4">
                    <input
                        type="text"
                        name="street"
                        required
                        placeholder=" "
                        class="peer w-3/4 px-3 py-2 bg-secondary border border-custom rounded-lg focus:border-blue-500" />
                    <label
                        class="absolute left-3 top-2 text-gray-400  px-1 text-opacity-40
          peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-base
          peer-focus:-top-2 peer-focus:text-sm peer-focus:text-yellow-500">
                        Address (locality, building, street)*
                    </label>
                </div>

                <!-- ADDRESS TYPE -->
                <div class="mb-4">
                    <h2 class="mb-1">Address Type</h2>
                    <label class="mr-4">
                        <input type="radio" name="addtype" value="home"
                            required>
                        Home
                    </label>
                    <label>
                        <input type="radio" name="addtype" value="office">
                        Office
                    </label>
                </div>

                <div class="mb-4">
                    <input type="checkbox" name="defaultAddress">
                    Make this my default address
                </div>
                <input
                    type="submit"
                    value="Create My Address"
                    class=" mb-4 px-6 py-3 rounded-full bg-blue-600 text-white hover:bg-blue-700" />
            </form>
            <button
                id="openAddressModal"
                type="button"
                class="px-6 py-3 rounded-full bg-blue-600 text-white">
                Use My Default Address
            </button>

            <div
                id="addressModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">

                <div
                    class="bg-white w-[600px] max-h-[80vh] rounded-xl p-6 overflow-y-auto">

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Select Delivery
                            Address</h2>
                        <button id="closeModal" class="text-xl">&times;</button>
                    </div>

                    <% if (addresses && addresses.length > 0) { %>
                    <% addresses.forEach(address => { %>
                    <div
                        class="border rounded-lg p-4 mb-4 hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center gap-2">
                            <input
                                type="radio"
                                name="selectedAddress"
                                value="<%= address._id %>"
                                <%= address.defaultAddress ? "checked" : " " %>
                            />
                            <strong><%= address.name %></strong>

                            <span
                                class="text-xs bg-green-100 text-green-700 px-2 rounded">
                                <%= address.addressType.toUpperCase() %>
                            </span>
                        </div>

                        <p class="mt-2">
                            <%= address.House_no %>, <%= address.Address %>
                        </p>

                        <p>Pin: <%= address.PinCode %></p>
                        <p>Mobile: <%= address.Mobile_no %></p>
                    </div>
                    <% }) %>
                    <% } else { %>
                    <p>No saved addresses</p>
                    <% } %>

                </div>
            </div>

        </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="w-[40%] ">

        <!-- DELIVERY ESTIMATES -->
        <div class="shadow-md rounded-xl p-6 mb-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">Delivery Estimates</h3>

            <!-- SCROLLABLE CONTAINER -->
            <div class="space-y-4 max-h-[290px] overflow-y-auto pr-2">

                <% cartItems.forEach(item => { %>
                <div
                    class="flex gap-4 items-center border-b last:border-b-0 pb-4">

                    <img
                        src="data:image/jpeg;base64,<%= item.image.toString('base64') %>"
                        alt="<%= item.name %>"
                        class="w-16 h-16 object-cover rounded-lg" />

                    <div class="flex-1">
                        <p class="font-medium text-sm"><%= item.name %></p>
                        <p class="text-xs text-gray-400">
                            Estimated delivery by <b>27 Jan 2026</b>
                        </p>
                    </div>

                    <p class="text-green-600 font-semibold text-sm">
                        â‚¹<%= item.price %>
                    </p>

                </div>
                <% }) %>

            </div>
        </div>

        <!-- PRICE BREAKDOWN -->
        <div class="shadow-lg rounded-xl p-6 sticky top-28">

            <h3 class="text-lg font-semibold mb-4">Price Breakdown</h3>

            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span>Total MRP</span>
                    <span>â‚¹<span id="totalMrp">0</span></span>
                </div>

                <div class="flex justify-between">
                    <span>Discount on MRP</span>
                    <span class="text-green-600">
                        - â‚¹ <span id="totalDiscount">0</span>
                    </span>
                </div>

                <div class="flex justify-between">
                    <span>Platform Fee</span>
                    <span>â‚¹ 35</span>
                </div>

                <div class="flex justify-between">
                    <span>Shipping Fee</span>
                    <span class="text-green-600">FREE</span>
                </div>
            </div>

            <div class="h-px bg-gray-300 my-5"></div>

            <div class="flex justify-between items-center mb-4">
                <span class="font-semibold text-lg">Total Amount</span>
                <span class="font-semibold text-lg text-green-600">
                    â‚¹ <span id="totalAmount">35</span>
                </span>
            </div>

            <!-- CONTINUE BUTTON -->
            <button
                id="continueBtn"
                class="relative overflow-hidden w-full px-6 py-3 bg-blue-500 text-white rounded-full font-medium hover:bg-blue-600 transition">

                <span id="btnText">Continue</span>

                <!-- ARROW -->
                <img
                    id="arrow"
                    src="../images/right-arrow.png"
                    class="absolute top-1/2 -translate-y-1/2 left-4 w-6 opacity-0" />

            </button>

        </div>
    </div>
</div>

<%- include('./partials/footer') %>

<script>
  const btn = document.getElementById("continueBtn");
  const arrow = document.getElementById("arrow");
  const text = document.getElementById("btnText");

  btn.addEventListener("click", () => {

    // ðŸ”’ Block click if disabled (no address selected)
    if (btn.disabled) return;

    // ðŸ” Check selected address
    const selectedAddress = document.querySelector(
      'input[name="selectedAddress"]:checked'
    );

    if (!selectedAddress) return;

    btn.disabled = true;
    text.innerText = "Processing...";

    arrow.classList.remove("opacity-0");
    arrow.classList.add("opacity-100");

    arrow.animate(
      [
        { left: "16px" },
        { left: "80%" }
      ],
      {
        duration: 900,
        easing: "ease-in-out",
        fill: "forwards"
      }
    );

    // ðŸš€ Navigate after animation (with address ID)
    setTimeout(() => {
      window.location.href =
        `/users/payment?addressId=${selectedAddress.value}`;
    }, 1000);
  });
</script>


<!-- for Use my Default Address button -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    const openBtn = document.getElementById("openAddressModal");
    const modal = document.getElementById("addressModal");
    const closeBtn = document.getElementById("closeModal");

    if (!openBtn || !modal || !closeBtn) {
      console.log("Modal elements missing");
      return;
    }

    openBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
    });

    closeBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    // close on backdrop click
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
      }
    });

  });
</script>

<script>
  const platformFee = 35;

  const cartItems = JSON.parse(`<%- JSON.stringify(cartItems) %>`);

  let totalMrp = 0;
  let totalDiscount = 0;

  cartItems.forEach(item => {
    const price = Number(item.price);
    const qty = Number(item.quantity || 1);
    const discount = Number(item.discount || 0);

    const mrp = price * qty;
    const dis = (mrp * discount) / 100;

    totalMrp += mrp;
    totalDiscount += dis;
  });

  document.getElementById("totalMrp").textContent = totalMrp.toFixed(0);
  document.getElementById("totalDiscount").textContent = totalDiscount.toFixed(0);
  document.getElementById("totalAmount").textContent =
    (totalMrp - totalDiscount + platformFee).toFixed(0);
</script>
