<%- include('./partials/header') %> 
<% if(success && success.length>0){ %>
<div
  class="absolute top-5 left-1/2 -translate-x-1/2 -translate-y-1/2 p-3 rounded-md bg-blue-500"
>
  <span class="inline-block mt-1 mb-1 text-white"> <%= success %> </span>
</div>
<% } %>

<div class="min-h-screen flex flex-col">
  <div class="container px-10 py-20 flex flex-grow">
    <div class="w-[25%] flex h-screen flex-col items-start">
      <div class="flex flex-col">
        <a class="block w-fit mb-2 text-blue-500" href="">All Products</a>
        <a class="block w-fit mb-2" href="#dharm">Create new product</a>
      </div>
      <div class="mt-8">
        <button onclick="deleteAllProducts()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
          Delete All Products
        </button>
      </div>
    </div>
    <main class="w-3/4 bg-primary p-8 shadow ml-4">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">Product Management</h2>
        <a  class="text-xl font-bold" href="#dharm">Create New Product</a>
      </div>
      
      <!-- Products List -->
      <% if(products && products.length > 0) { %>
      <div class="mb-8 ">
        <h3 class="text-lg font-semibold mb-4">Existing Products</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <% products.forEach(function(product){ %>
          <div class="border rounded-lg p-4 bg-secondary">
            <div class="w-full h-32 bg-[<%= product.bgcolor || '#f3f4f6' %>] flex items-center justify-center mb-3">
              <% if(product.image) { %>
                <img class="h-24 object-contain" src="data:image/jpeg;base64,<%= product.image.toString('base64') %>" alt="<%= product.name %>">
              <% } else { %>
                <span class="text-gray-500">No Image</span>
              <% } %>
            </div>
            <div class="flex justify-between items-center">
              <div>
                <h4 class="font-semibold"><%= product.name %></h4>
                <p class="text-sm">â‚¹ <%= product.price %></p>
                <% if(product.discount > 0) { %>
                  <p class="text-sm text-green-600">Discount: <%= product.discount %>%</p>
                <% } %>
              </div>
              <div class="flex gap-2">
                <button onclick="deleteProduct('<%= product._id %>')" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                  Delete
                </button>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
      <% } else { %>
      <div class="mb-8">
        <h3 class="text-lg font-semibold mb-4">No Products Found</h3>
        <p class="text-secondary">Create your first product using the form below.</p>
      </div>
      <% } %>

      <!-- Create Product Form -->
      <div class="border-t pt-6">
        <h3 class="text-lg font-semibold mb-4">Create New Product</h3>
        <form
          autocomplete="off"
          action="/products/create"
          method="post"
          enctype="multipart/form-data", id="dharm"
        >
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Product Details</h3>
              <div class="mb-4">
                <label class="block mb-2 font-medium">Product Image</label>
                <input
                  name="image"
                  type="file"
                  class="py-2 px-4 rounded w-full border border-custom bg-secondary text-primary"
                  value="Select File"
                />
              </div>
              <div class="grid grid-cols-2 gap-4">
                <input
                  name="name"
                  type="text"
                  placeholder="Product Name"
                  class="border p-2 rounded w-full border-custom bg-secondary text-primary"
                />
                <input
                  name="price"
                  type="text"
                  placeholder="Product Price"
                  class="border p-2 rounded w-full border-custom bg-secondary text-primary"
                />
                <input
                  name="discount"
                  type="text"
                  placeholder="Discount Price"
                  class="border p-2 rounded w-full border-custom bg-secondary text-primary"
                />
              </div>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-2">Panel Details</h3>
              <div class="grid grid-cols-2 gap-4">
                <input
                  name="bgcolor"
                  type="text"
                  placeholder="Background Color"
                  class="border p-2 rounded w-full border-custom bg-secondary text-primary"
                />
                <input
                  name="panelcolor"
                  type="text"
                  placeholder="Panel Color"
                  class="border p-2 rounded w-full border-custom bg-secondary text-primary"
                />
                <input
                  name="textcolor"
                  type="text"
                  placeholder="Text Color"
                  class="border p-2 rounded w-full border-custom bg-secondary text-primary"
                />
              </div>
          </div>
          <input
            class="px-5 py-2 rounded mt-3 accent-bg text-white accent-hover"
            type="submit"
            value="Create New Product"
          />
        </form>
      </div>
    </main>
  </div>
</div>

<script>
function deleteProduct(productId) {
  if(confirm('Are you sure you want to delete this product?')) {
    fetch(`/owners/delete/${productId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if(data.success) {
        alert('Product deleted successfully');
        location.reload();
      } else {
        alert('Failed to delete product: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting product');
    });
  }
}

function deleteAllProducts() {
  if(confirm('Are you sure you want to delete ALL products? This action cannot be undone!')) {
    fetch('/owners/delete/all', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if(data.success) {
        alert('All products deleted successfully');
        location.reload();
      } else {
        alert('Failed to delete products: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting products');
    });
  }
}
</script>

<%- include('./partials/footer') %>
